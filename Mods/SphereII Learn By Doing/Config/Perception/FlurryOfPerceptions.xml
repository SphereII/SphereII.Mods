<configs>
	<!-- Append the LBD logic for Flurry of Perception to the main Perception Manager buff. -->
	<append xpath="/buffs/buff[@name='buffLBD_PerceptionManager']">
		<effect_group name="Flurry of Perception">
			<requirement name="HoldingItemHasTags" tags="perkJavelinMaster"/>
			<requirement name="IsAlive" target="other"/>

			<triggered_effect trigger="onSelfPrimaryActionRayHit" action="ModifyCVar" cvar="$perkflurryofperception_lbd_xp" operation="add" value="@$lbd_xp_flurry_bonus">
				<requirement name="HasBuff" buff="buffLBD_Flurry_ComboWindow"/>
			</triggered_effect>
			<triggered_effect trigger="onSelfSecondaryActionRayHit" action="ModifyCVar" cvar="$perkflurryofperception_lbd_xp" operation="add" value="@$lbd_xp_flurry_bonus">
				<requirement name="HasBuff" buff="buffLBD_Flurry_ComboWindow"/>
			</triggered_effect>

			<triggered_effect trigger="onSelfPrimaryActionRayHit" action="AddBuff" buff="buffLBD_Flurry_ComboWindow"/>
			<triggered_effect trigger="onSelfSecondaryActionRayHit" action="AddBuff" buff="buffLBD_Flurry_ComboWindow"/>

			<triggered_effect trigger="onSelfPrimaryActionRayHit" action="AddBuff" buff="buffLBD_perkFlurryOfPerception_LevelUpCheck">
				<requirement name="CVarCompare" cvar="$perkflurryofperception_lbd_xp" operation="GTE" value="@$perkflurryofperception_lbd_xptonext"/>
			</triggered_effect>
			<triggered_effect trigger="onSelfSecondaryActionRayHit" action="AddBuff" buff="buffLBD_perkFlurryOfPerception_LevelUpCheck">
				<requirement name="CVarCompare" cvar="$perkflurryofperception_lbd_xp" operation="GTE" value="@$perkflurryofperception_lbd_xptonext"/>
			</triggered_effect>

			<triggered_effect trigger="onSelfPrimaryActionRayHit" action="LogMessage" message="LBD DEBUG: Flurry of Perception Primary - COMBO HIT! Applying Bonus XP (+@$lbd_xp_flurry_bonus)">
				<requirement name="HasBuff" buff="buffLBD_Flurry_ComboWindow"/>
				<requirement name="HasBuff" buff="god"/>
			</triggered_effect>
			<triggered_effect trigger="onSelfSecondaryActionRayHit" action="LogMessage" message="LBD DEBUG: Flurry of Perception Secondary - COMBO HIT! Applying Bonus XP (+@$lbd_xp_flurry_bonus)">
				<requirement name="HasBuff" buff="buffLBD_Flurry_ComboWindow"/>
				<requirement name="HasBuff" buff="god"/>
			</triggered_effect>
			<triggered_effect trigger="onSelfPrimaryActionRayHit" action="LogMessage" message="LBD DEBUG: Flurry of Perception Primary - Starting/Refreshing Combo Window">
				<requirement name="HasBuff" buff="god"/>
			</triggered_effect>
			<triggered_effect trigger="onSelfSecondaryActionRayHit" action="LogMessage" message="LBD DEBUG: Flurry of Perception Secondary - Starting/Refreshing Combo Window">
				<requirement name="HasBuff" buff="god"/>
			</triggered_effect>
		</effect_group>
	</append>

	<!-- Define the Level-Up Handler and the Combo Window buff. -->
	<append xpath="/buffs">
		<!-- The temporary buff that creates the combo window. 'stack_type="replace"' is CRITICAL. -->
		<buff name="buffLBD_Flurry_ComboWindow" hidden="true">
			<stack_type value="replace"/>
			<duration value="2"/>
		</buff>

		<buff name="buffLBD_perkFlurryOfPerception_LevelUpCheck" hidden="true">
			<stack_type value="ignore"/><duration value="1"/>
			<effect_group>
				<requirement name="CanPurchasePerk, SCore" progression_name="perkFlurryOfPerception" />
				<triggered_effect trigger="onSelfBuffStart" action="AddProgressionLevel" progression_name="perkFlurryOfPerception" level="1"/>
				<triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="$perkflurryofperception_lbd_xp" operation="subtract" value="@$perkflurryofperception_lbd_xptonext"/>
				<triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="$perkflurryofperception_lbd_xptonext" operation="multiply" value="@$lbd_xp_curve_multiplier"/>
				<triggered_effect trigger="onSelfBuffStart" action="ShowPerkLevelUp, SCore" perk="perkFlurryOfPerception" sound="read_skillbook_final" />
			</effect_group>
			<effect_group>
				<requirement name="!CanPurchasePerk, SCore" progression_name="perkFlurryOfPerception" />
				<triggered_effect trigger="onSelfBuffStart" action="LogMessage" message="LBD DEBUG: Flurry of Perception - Level Up FAILED. Perk is locked by requirements.">
					<requirement name="HasBuff" buff="god"/>
				</triggered_effect>
			</effect_group>
		</buff>
	</append>
</configs>